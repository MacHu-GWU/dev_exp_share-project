WORM Compliance in Data Industry
==============================================================================


Overview
------------------------------------------------------------------------------
在数据合规领域, WORM (Write Once Read Many) 是一个很常见的合规术语. 本文从 数据架构师, 合规审查人员, 企业主 等多个视角出发, 介绍了 WORM 合规性的概念, 特性要求. 并且我本人作为数据架构师, 也分享了一些关于如何设计符合 WORM 合规性要求的数据架构的经验.


What is WORM Compliance
------------------------------------------------------------------------------
WORM (Write Once Read Many) 合规性是一种数据存储策略, 要求数据一旦写入后就不能修改或删除, 只能读取. 这是为了确保数据的完整性, 真实性和不可否认性, 在许多行业如金融, 医疗, 法律等都有严格的监管要求.

注意, WORM 跟 CCPA 和 GDPR 这些著名的数据合规法案不同, 它不是一个特定的法律条文, 而是对一种数据合规性要求的描述. 例如: `SEC Rule 17a-4 <https://www.sec.gov/investment/amendments-electronic-recordkeeping-requirements-broker-dealers>`_ 就做出了关于 WORM 的要求. `FINRA rules <https://www.finra.org/rules-guidance/key-topics/books-records>`_ 也有类似的要求.

简单来说 WORM 有三点要求:

- Immutable storage: Once data is written, it becomes immutable, meaning it cannot be modified or deleted.
- Time-defined data retention: Data stored using WORM technology has a predetermined retention period during which it cannot be altered.
- Audit trails: WORM backup solutions often include audit trails, ensuring transparency and traceability of data access and modifications.


Feature Requirements to be WORM Compliant
------------------------------------------------------------------------------
这里我们从合规审查人员的视角出发, 来看看审查企业数据系统是否符合 WORM 规范时, 会看那些特性. 而企业的 Data Architect 就可以在设计数据系统时参考这些特性来确保合规. 以下是一些关键的特性:

这里我们从合规审查人员的视角出发, 来看看审查企业数据系统是否符合  WORM  规范时, 会看那些特性. 而企业的  Data   Architect  就可以在设计数据系统时参考这些特性来确保合规. 以下是一些关键的特性:

1. 数据不可篡改性: 确保一旦数据写入, 就无法修改或删除. 需要检查:
    - 是否存在防止数据被覆盖或篡改的技术控制措施, 如版本控制, 条件写入等.
    - 数据删除是否仅限于自动过期删除, 而非人为删除.
    - 是否存在完整的数据变更记录和审计跟踪.
2. 数据保留期管理: 评估数据的保留期是否符合法规要求. 需要检查:
    - 是否为不同类型的数据设置了适当的保留期.
    - 过期数据是否按照保留政策自动删除, 删除过程是否不可逆.
    - 保留期是否符合行业特定法规, 如  SOX, HIPAA, FINRA  等.
3. 数据备份和恢复: 评估数据备份策略是否完善, 以确保数据可恢复. 需要检查:
    - 备份是否定期进行, 备份数据是否不可篡改.
    - 是否制定了数据恢复程序, 并定期测试.
    - 备份数据是否存储在独立的, 安全的位置.
4. 访问控制和权限管理: 审查对  WORM  数据的访问控制是否严格. 需要检查:
    - 是否实施了最小权限原则, 严格限制写入和删除权限.
    - 访问控制是否遵循职责分离原则.
    - 是否定期审查和调整用户权限.
5. 数据安全和加密: 评估数据是否受到适当的安全保护. 需要检查:
    - 静态数据和传输中的数据是否使用强加密算法加密.
    - 加密密钥管理是否安全和规范.
    - 是否定期进行安全风险评估和渗透测试.
6. 物理安全: 如果使用自建数据中心, 您还需要审查物理安全措施, 如:
    - 数据中心的访问控制是否严格.
    - 是否提供适当的环境控制, 如温度, 湿度监测等.
    - 是否制定了充分的灾难恢复和业务连续性计划.
7. 第三方风险管理: 如果企业使用外包服务或云服务, 需要审查:
    - 服务提供商是否符合 WORM 和其他相关合规要求.
    - 是否与服务提供商签订了适当的服务级别协议 (SLA).
    - 是否定期评估服务提供商的合规性和绩效表现.
8. 员工培训和意识: 评估企业是否提供了充分的员工培训. 需要检查:
   - 员工是否接受过数据管理和合规性方面的培训.
   - 是否定期开展数据安全意识教育.
   - 是否建立了明确的数据管理政策和程序, 并有效传达给员工.


When Need To Check WORM Compliance
------------------------------------------------------------------------------
现在我们切换到企业主的视角, 了解一下企业通常会在什么情况下收到数据合规性审查要求. 这样我们才能更好的进行准备.

企业通常会在以下几种情况下收到数据合规性审查要求, 既包括定期检查, 也包括突发事件触发的审查:

1. 定期监管审查: 许多行业如金融, 医疗, 能源等都有定期的合规性审查要求. 监管机构会按照规定的时间间隔 (如每年或每季度) 对企业进行例行检查, 以确保其数据管理实践持续符合相关法规标准. 这类审查通常有明确的时间表和范围, 企业可以提前做好准备.
2. triggered by incidents or complaints: 如果发生重大数据安全事故 (如数据泄露, 黑客入侵等) 或收到客户, 员工或其他相关方的投诉, 监管机构或执法部门可能会对企业发起特别合规性审查. 这种审查往往是突发性的, 企业需要及时响应并配合调查.
3. 法规变更: 当适用于企业的数据合规性法规发生重大变化时, 监管机构可能会要求企业接受特别审查, 以确保其已经及时调整数据管理实践以符合新要求.
4. 重大业务变更: 如果企业发生重大的业务变更, 如并购, 重组, 新产品或服务的推出等, 监管机构可能会要求进行合规性审查, 以评估这些变更对数据管理的影响, 并确保持续合规.
5. 合同或协议要求: 某些商业合同或服务协议可能包含合规性审查条款. 例如, 如果企业为客户处理敏感数据, 客户可能会要求定期对企业进行合规性审查, 以确保其数据得到适当保护.
6. 自愿审查: 有些企业出于自身的风险管理或合规性目标, 可能会主动聘请第三方审计机构对其数据管理实践进行独立评估. 这种自愿审查可以帮助企业及早发现和纠正合规性问题, 提高数据治理水平.

综上所述, 数据合规性审查可以是定期的, 也可以是由特定事件或情况触发的. 企业应当建立完善的数据治理体系, 时刻准备接受审查. 同时, 企业也应当密切关注相关法规动态和行业最佳实践, 主动进行自我评估和改进, 而不是被动等待外部审查. 通过将合规性要求融入日常数据管理实践, 企业可以更高效, 更从容地应对各种审查要求.


WORM Compliance Audit Timeline
------------------------------------------------------------------------------
现在我们切回到合规审查人员的视角, 看看一个典型的 WORM 数据合规性审查的时间流程是怎样的. 而企业的合规团队就可以配合这个时间线来做好准备.

当政府审查部门对一个公司开始进行 WORM 数据合规性检查时, 整个过程通常分为几个阶段, 每个阶段涉及不同的活动和参与者. 以下是一个典型的审查时间线:

1. 通知阶段:
    - 政府审查部门向公司发出正式的审查通知, 说明审查的目的, 范围和要求.
    - 公司的高级管理层, 包括首席执行官 (CEO), 首席合规官 (CCO) 和首席信息官 (CIO) 等, 会收到通知并开始准备应对.
2. 准备阶段:
    - 公司成立内部合规性审查工作组, 成员通常包括合规部门, IT 部门, 法律部门和业务部门的代表.
    - 工作组收集和整理所需的文档和记录, 如数据管理政策, 程序文档, 技术配置记录等.
    - 工作组可能会聘请外部法律顾问或合规性顾问, 以获得专业指导和支持.
    - IT 部门开始准备系统演示和技术审查所需的环境和数据.
3. 现场审查阶段:
    - 政府审查人员到达公司进行现场审查.
    - 审查人员与公司管理层和关键员工进行会面和访谈, 了解公司的数据管理实践.
    - 审查人员查看公司提供的文档和记录, 评估其完整性和合规性.
    - IT 人员向审查人员演示数据管理系统的功能和配置, 回答技术方面的问题.
    - 审查人员可能会抽取部分数据样本进行深入检查和分析.
4. 问题澄清和整改阶段:
    - 审查人员可能会就发现的问题或疑虑向公司提出澄清或补充材料的要求.
    - 公司工作组需要及时回应这些要求, 提供额外的文档, 解释或证据.
    - 如果审查过程中发现了合规性问题, 审查人员可能会要求公司提交整改计划.
    - 公司需要与审查人员沟通, 商定整改措施和时间表.
5. 审查报告和后续行动阶段:
    - 审查人员完成现场工作后, 会准备一份详细的审查报告, 说明审查发现和结论.
    - 报告会提交给公司管理层和相关监管机构.
    - 如果审查发现公司存在重大合规性问题, 监管机构可能会采取进一步的执法行动, 如罚款, 限制业务等.
    - 公司需要按照审查报告的建议和整改计划, 及时解决所有 identified 的合规性问题.
    - 公司的合规部门和内审部门需要对整改措施的实施进行持续监督和评估.
6. 持续合规阶段:
    - 公司应当吸取审查经验教训, 改进其数据治理和合规性管理体系.
    - 合规性应当成为公司文化和日常运营的重要组成部分, 而不仅仅是应对外部审查.
    - 公司应当定期开展内部合规性评估和培训, 确保员工了解和遵守最新的数据管理要求.
    - 公司应当与监管机构保持开放和透明的沟通, 及时报告重大变化和事件.

总的来说, 一个 WORM 数据合规性审查可能会持续数周甚至数月, 涉及公司内外部的多个利益相关方. 公司需要全面动员资源, 与审查人员密切配合, 同时也要把合规性审查作为改进内部控制和提高数据治理水平的契机. 只有将合规性深入融入企业文化和运营, 才能真正实现可持续的合规.


As a Data Architect, How to Support WORM Compliance Audit
------------------------------------------------------------------------------
下面我们把视角切换到 Data Architect, 来了解一下在合规审查过程中要做哪些事情. 有了这个预期 Data Architect 就能提前在合规审查到来之前就做好春分准备.

作为数据部门的架构师, 您在公司内部合规审计工作组中扮演着关键角色. 您需要在整个审查过程中与工作组密切配合, 提供技术专业知识和支持. 以下是您在各个阶段的主要职责和需要提供的内容:

1. 准备阶段:
    - 参与制定数据管理政策和程序文档, 确保其符合 WORM 合规性要求.
    - 提供数据架构和数据流程的详细文档, 包括数据模型, 数据字典, ETL 流程等.
    - 准备数据管理系统的技术配置文档, 如硬件规格, 软件版本, 安全设置等.
    - 协助识别和收集与 WORM 合规性相关的系统日志, 审计跟踪记录等.
    - 与 IT 部门协调, 准备系统演示环境和测试数据.
2. 现场审查阶段:
    - 向审查人员介绍数据架构和数据管理系统的总体设计.
    - 演示数据管理系统的关键功能, 如数据写入, 版本控制, 保留期管理, 删除等.
    - 回答审查人员关于数据模型, 数据流程, 元数据管理等方面的问题.
    - 提供系统配置的详细说明, 证明其符合 WORM 合规性要求.
    - 协助审查人员进行数据样本的提取和分析.
3. 问题澄清和整改阶段:
    - 就审查人员提出的技术问题或疑虑提供澄清和补充说明.
    - 协助准备补充的技术文档或证据材料.
    - 参与制定整改计划, 提出技术层面的解决方案和实施步骤.
    - 评估整改措施对数据架构和系统性能的影响.
4. 审查报告和后续行动阶段:
    - 审查技术部分的审查报告, 确保审查发现和结论的准确性.
    - 协助制定详细的技术整改方案, 包括所需的资源, 时间表和里程碑.
    - 监督整改措施的实施, 确保其满足合规性要求.
    - 对整改后的数据管理系统进行全面测试和验证.
    - 准备整改完成报告, 说明所有技术问题已得到解决.
5. 持续合规阶段:
    - 将 WORM 合规性要求纳入数据架构设计和开发流程.
    - 定期审查和更新数据管理政策和程序, 确保其与最新的合规性要求保持一致.
    - 建立数据合规性的监控和预警机制, 及时发现和解决潜在的合规性风险.
    - 对数据管理系统进行定期的合规性自查和内部审计.
    - 为 IT 人员和业务用户提供数据合规性方面的培训和指导.

总的来说, 作为数据架构师, 您需要在整个审查过程中发挥技术领导作用, 确保所提供的所有文档, 演示和说明都能够清晰, 准确地证明公司的数据管理实践符合 WORM 合规性要求. 您还需要主动识别和解决技术层面的合规性问题, 并推动数据合规性要求在日常数据管理工作中的落实. 通过与合规审计工作组的密切配合, 您可以帮助公司顺利通过合规性审查, 并建立起可持续的数据合规性管理体系.


DynamoDB Architecture for WORM Compliance
------------------------------------------------------------------------------
我我们以 Amazon DynamoDB 为例, 来看看如何设计一个符合 WORM 合规性要求的数据架构. 我会先给出架构设计, 然后会参考 "Feature Requirements to be WORM Compliant" 中提到的特性, 将这些特性一一映射到 DynamoDB 的架构设计上.

我是 Data Architect. 我设计了一套符合 WORM 合规要求的 DynamoDB 的解决方案.

1. Business Operation 业务都由一个 "主表" 负责, 所有 增删插改 操作都正常进行.
2. 给 "主表" 配置一个 `DynamoDB stream <https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html>`_, stream 里会包含所有的 Put 和 Update 操作的修改前和修改后的 item 的记录, 以及 Delete 操作的删除前的 item 的记录.
3. DynamoDB stream 中的数据会严格按照时间顺序被消费.
4. DynamoDB stream 会按照时间进行 partition 将其保存在 S3 上. 这些 S3 上的数据构成了完整的 Change Log / Audit Log. 我们可以从 Log 将表恢复到任意时间点的状态.
5. 我们的 S3 bucket 开启了 versioning, 确保了数据不会被意外覆盖.
6. 我们使用了 `S3 object lock <https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html>`_, 其中 retention 可以确保在一定时间内历史数据无法被删除, 其中 governance mode 能确保连 AWS 的 Admin 都无法删除该历史数据.
7. 我们使用了 `S3 life cycle policy <https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html>`_, 它能确保数据在到期后被永久删除.
8. 我们在消费数据时会将同一时间段的数据按照列式存储的格式将不同的 attribute 保存为不同的文件. 这样可以做到为不同的 attribute 配置不同的过期时间策略.
9. 为 S3 bucket 配置了合理的 ACL 和 bucket policy, 确保只有极少的授权用户 (通常是管理员和审计人员) 能够读取这些文件, 但是没有覆盖和删除文件的权限.
10. 为 S3 bucket 配置了 `replicating <https://docs.aws.amazon.com/AmazonS3/latest/userguide/replication.html>`_, 历史数据被同步备份到了多个 AWS region, 进一步确保了数据的安全性.
11. 我们使用了 KMS 对 S3 上的数据进行了加密, 并且数据在传输过程中也是加密的.

下面我把这套方案和 WORM 合规的要求一一对应上了:

1. 数据不可篡改性: 确保一旦数据写入, 就无法修改或删除. 需要检查:
    - 是否存在防止数据被覆盖或篡改的技术控制措施, 如版本控制, 条件写入等.
        - Answer: 所有数据修改历史记录都备份到了 S3, 并且 S3 object lock + ACL + bucket policy 保证了数据不会被覆盖和意外删除.
    - 数据删除是否仅限于自动过期删除, 而非人为删除.
        - Answer: 数据由 S3 life cycle policy 确保自动删除, 而非人为删除.
    - 是否存在完整的数据变更记录和审计跟踪.
        - Answer: 在 S3 上由完整的数据变更记录, 可以对任意时间点的历史数据进行审计.
2. 数据保留期管理: 评估数据的保留期是否符合法规要求. 需要检查:
    - 是否为不同类型的数据设置了适当的保留期.
        - Answer: 是的, 列示存储的方式可以为不同的 attribute 配置不同的删除策略.
    - 过期数据是否按照保留政策自动删除, 删除过程是否不可逆.
        - Answer: 是的, 按照政策历史数据到期后被永久删除, 不可恢复 (我们也可以做到可以恢复, 合规怎么要求我们就怎么做)
    - 保留期是否符合行业特定法规, 如  SOX, HIPAA, FINRA  等.
3. 数据备份和恢复: 评估数据备份策略是否完善, 以确保数据可恢复. 需要检查:
    - 备份是否定期进行, 备份数据是否不可篡改.
        - Answer: 备份数据是实时进行的, 并且 S3 object lock 确保了备份数据不可被篡改.
    - 是否制定了数据恢复程序, 并定期测试.
        - Answer: 我们会定期从 S3 恢复整个 DynamoDB 作为测试.
    - 备份数据是否存储在独立的, 安全的位置.
        - Answer: 是, 备份数据会横跨多个 AWS region, 以确保数据的安全性.
4. 访问控制和权限管理: 审查对  WORM  数据的访问控制是否严格. 需要检查:
    - 是否实施了最小权限原则, 严格限制写入和删除权限.
        - Answer: 是.
    - 访问控制是否遵循职责分离原则.
        - Answer: 是.
    - 是否定期审查和调整用户权限.
        - Answer: 是.
5. 数据安全和加密: 评估数据是否受到适当的安全保护. 需要检查:
    - 静态数据和传输中的数据是否使用强加密算法加密.
        - Answer: 是.
    - 加密密钥管理是否安全和规范.
        - Answer: 是.
    - 是否定期进行安全风险评估和渗透测试.
        - Answer: 是.


RDBMS Architecture for WORM Compliance
------------------------------------------------------------------------------
我们以 RDBMS 为例, 来看看如何设计一个符合 WORM 合规性要求的数据架构.

总体来说, 方案的架构跟 DynamoDB 的方案一致, 都是将数据修改记录用 Stream 的方式同步到 S3 上. 我们可以使用 AWS Database Migration Service 来更容易的实现这一点.
